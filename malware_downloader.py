#!/usr/bin/env python3


import requests
import pyzipper
import os
import time
from pathlib import Path


class MalwareBazaarDownloader:
    BASE_URL = "https://mb-api.abuse.ch/api/v1/"
    ZIP_PASSWORD = b"infected"

    def __init__(self, api_key: str, download_dir: str = "./samples"):
        self.api_key = api_key
        self.download_dir = Path(download_dir)
        self.zip_dir = self.download_dir / "zipped"
        self.extracted_dir = self.download_dir / "extracted"

        for d in [self.download_dir, self.zip_dir, self.extracted_dir]:
            d.mkdir(parents=True, exist_ok=True)

        self.session = requests.Session()
        self.session.headers.update({"Auth-Key": self.api_key})

    def get_recent_samples(self, limit: int = 100) -> list:
        """Fetch recent samples (max 100 per query)."""
        response = self.session.post(self.BASE_URL, data={"query": "get_recent", "selector": limit})
        result = response.json()
        return result.get("data", []) if result.get("query_status") == "ok" else []

    def get_samples_by_signature(self, signature: str, limit: int = 100) -> list:
        """Fetch samples by malware signature/family."""
        response = self.session.post(self.BASE_URL,
            data={"query": "get_siginfo", "signature": signature, "limit": limit})
        result = response.json()
        return result.get("data", []) if result.get("query_status") == "ok" else []

    def get_samples_by_tag(self, tag: str, limit: int = 100) -> list:
        """Fetch samples by tag (exe, dll, doc, etc.)."""
        response = self.session.post(self.BASE_URL,
            data={"query": "get_taginfo", "tag": tag, "limit": limit})
        result = response.json()
        return result.get("data", []) if result.get("query_status") == "ok" else []

    def download_sample(self, sha256_hash: str) -> bool:
        """Download and extract a single sample."""
        # Skip if already exists
        if list(self.extracted_dir.glob(f"{sha256_hash}.*")):
            return True

        try:
            response = self.session.post(self.BASE_URL,
                data={"query": "get_file", "sha256_hash": sha256_hash}, timeout=60)

            if response.content[:2] == b'PK':  # ZIP file
                zip_path = self.zip_dir / f"{sha256_hash}.zip"
                with open(zip_path, "wb") as f:
                    f.write(response.content)

                # Extract with pyzipper (supports AES encryption)
                with pyzipper.AESZipFile(zip_path, 'r') as zf:
                    zf.extractall(path=self.extracted_dir, pwd=self.ZIP_PASSWORD)
                return True
            else:
                return False
        except Exception as e:
            print(f"Error: {e}")
            return False

    def download_all(self) -> dict:
        """Download samples from multiple sources."""
        all_samples = {}

        print("Collecting samples from multiple sources...")
        print("=" * 60)

        # Recent samples
        print("Fetching recent samples...")
        for s in self.get_recent_samples(100):
            all_samples[s["sha256_hash"]] = s
        print(f"  Found {len(all_samples)} samples")

        # By malware family
        signatures = ["AgentTesla", "Emotet", "Formbook", "RedLine", "Remcos",
                      "AsyncRAT", "QuasarRAT", "njRAT", "LokiBot", "Raccoon",
                      "Vidar", "AZORult", "Dridex", "TrickBot", "Cobalt Strike",
                      "Qakbot", "IcedID", "Amadey", "SmokeLoader", "GuLoader"]

        for sig in signatures:
            before = len(all_samples)
            for s in self.get_samples_by_signature(sig, 50):
                all_samples[s["sha256_hash"]] = s
            added = len(all_samples) - before
            if added > 0:
                print(f"  {sig}: +{added} samples")
            time.sleep(0.2)

        # By file type
        tags = ["exe", "dll", "doc", "xls", "js", "vbs", "ps1", "jar", "apk", "elf", "msi"]

        for tag in tags:
            before = len(all_samples)
            for s in self.get_samples_by_tag(tag, 50):
                all_samples[s["sha256_hash"]] = s
            added = len(all_samples) - before
            if added > 0:
                print(f"  Tag '{tag}': +{added} samples")
            time.sleep(0.2)

        print(f"\nTotal unique samples: {len(all_samples)}")
        print("=" * 60)

        # Download
        samples = list(all_samples.values())
        success, failed = 0, 0

        print("\nDownloading...\n")

        for i, sample in enumerate(samples):
            sha256 = sample["sha256_hash"]
            file_type = sample.get("file_type", "unknown")
            sig = sample.get("signature", "N/A")

            print(f"[{i+1}/{len(samples)}] {sha256[:28]}... ({file_type}, {sig})")

            if self.download_sample(sha256):
                success += 1
            else:
                failed += 1

            if (i + 1) % 25 == 0:
                print(f"\n--- Progress: {success} OK, {failed} failed ---\n")
                time.sleep(0.5)

        return {"success": success, "failed": failed}


def main():
    # Your API key from https://auth.abuse.ch/
    API_KEY = "266c8875df9d07b9ab59c7116f4a50df17732cad4bcade63"

    # Download directory (same folder as script)
    script_dir = Path(__file__).parent
    download_dir = script_dir / "samples"

    print("=" * 60)
    print("MalwareBazaar Sample Downloader")
    print("=" * 60)
    print(f"\nDownload directory: {download_dir}")
    print()

    downloader = MalwareBazaarDownloader(API_KEY, str(download_dir))
    results = downloader.download_all()

    print("\n" + "=" * 60)
    print("DOWNLOAD COMPLETE")
    print(f"  Success: {results['success']}")
    print(f"  Failed: {results['failed']}")
    print(f"\nFiles saved to: {download_dir / 'extracted'}")


if __name__ == "__main__":
    main()
